{"version":3,"sources":["../src/install.js"],"names":["childProcess","require","path","fse","util","CWD","process","cwd","TEMP","join","Math","random","install","npmPackage","options","destination","sanitize","overwrite","quiet","log","error","destinationPath","directoryExists","packageName","getPackageName","then","result","remove","mkdirs","pathExists","npmrcExists","copy","installOptions","stdio","command","platform","Promise","resolve","reject","ps","exec","stdout","on","data","stderr","code","from","to","filterRegex","RegExp","filter","src","dest","match","move","console","toString","Error","module","exports"],"mappings":"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","file":"install.js","sourcesContent":["const childProcess = require('child_process');\nconst path = require('path');\nconst fse = require(\"fs-extra\");\n\nconst util = require('./util.js');\n\nconst CWD = process.cwd();\nconst TEMP = path.join(CWD, 'niv_modules', '.npm-install-version-temp' + Math.random());\n\nfunction install (npmPackage, options = {}) {\n  const {\n    destination = util.sanitize(npmPackage),\n    overwrite = false,\n    quiet = false\n  } = options;\n\n  const log = quiet ? () => {} : (...args) => console.log(...args);\n\n  if (!npmPackage) util.error();\n  const destinationPath = path.join(CWD, 'niv_modules', destination);\n  if (!overwrite && util.directoryExists(destinationPath)) {\n    return log(`Directory at ${destinationPath} already exists, skipping`);\n  }\n\n  // get real package name\n  let packageName;\n  \n  return util.getPackageName(npmPackage)\n    .then(function(result) {\n      packageName = result;\n    })\n    .then(() => fse.remove(TEMP))\n    // make temp install dir\n    .then(() => fse.mkdirs(path.join(TEMP, 'node_modules')))\n\n    // copy local .npmrc file if exists\n    .then(() => fse.pathExists(path.join(CWD, '.npmrc')))\n    .then((npmrcExists) => {\n      if (npmrcExists) {\n        return fse.copy(path.join(CWD, '.npmrc'), path.join(TEMP, \".npmrc\"))\n      }\n    })\n\n    // install package to temp dir\n    .then(() => {\n      const installOptions = {\n        cwd: TEMP,\n        stdio: [null, null, null]\n      };\n      const command = process.platform === 'win32' ? 'npm.cmd' : 'npm';\n\n      return new Promise((resolve, reject) => {\n        const ps = childProcess.exec([command, 'install', npmPackage].join(\" \"), installOptions);\n\n        ps.stdout.on(\"data\", (data) => log(data));\n        ps.stderr.on(\"data\", (data) => log(data));\n        ps.on(\"close\", (code) => {\n            if(code !== 0) {\n              return reject(`npm install process exited with code ${code}`)\n            }\n            resolve();\n          });\n      });\n    })\n\n    // move deps inside package\n    .then(() => fse.mkdirs(path.join(TEMP, 'node_modules', packageName, 'node_modules')))\n    .then(() => {\n      const from = path.join(TEMP, 'node_modules');\n      const to = path.join(TEMP, 'node_modules', packageName, 'node_modules');\n      const filterRegex = new RegExp(\"^\" + path.join(TEMP, 'node_modules', packageName));\n      const filter = (src, dest) => {\n        return !src.match(filterRegex);\n      }\n\n      return fse.copy(from, to, { filter });\n    })\n\n    // copy to niv_modules/\n    .then(() => fse.remove(destinationPath))\n    .then(() => fse.move(path.join(TEMP, 'node_modules', packageName), destinationPath))\n\n    // cleanup\n    .then(() => fse.remove(TEMP))\n    .then(\n      () => log(`Installed ${npmPackage} to ${destinationPath}`),\n      error => {\n        console.error(`Error installing ${npmPackage}`);\n        console.error(error.toString());\n\n        throw Error(`Error installing ${npmPackage}`);\n      }\n    );\n}\n\nmodule.exports = install;\n"]}